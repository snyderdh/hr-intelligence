<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Intelligence Suite</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@2.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
<div id="appShell">
    <!-- TOP BAR -->
    <div id="topBar">
        <div class="brand">
            <div class="brand-icon">HR</div>
            <div class="brand-name">Intelligence <span>Suite</span></div>
        </div>
        <div id="statPills">
            <div class="stat-pill"><span class="pill-val" id="statHC">â€”</span><span class="pill-lbl">Headcount</span></div>
            <div class="stat-pill"><span class="pill-val" id="statPayroll">â€”</span><span class="pill-lbl">Payroll</span></div>
            <div class="stat-pill"><span class="pill-val" id="statAvgSal">â€”</span><span class="pill-lbl">Avg Salary</span></div>
            <div class="stat-pill"><span class="pill-val" id="statTenure">â€”</span><span class="pill-lbl">Avg Tenure</span></div>
            <div class="stat-pill"><span class="pill-val" id="statSpan">â€”</span><span class="pill-lbl">Span:1</span></div>
            <button id="undoBtn" onclick="undoLastMove()" style="display:none;">â†© Undo Move</button>
        </div>
        <div id="topActions">
            <button class="top-btn" onclick="toggleControls()">âš™ Controls</button>
            <button class="top-btn accent" onclick="toggleDashboard()">ğŸ“Š Dashboard</button>
            <button class="top-btn primary" onclick="toggleAI()">âœ¦ Ask Claude</button>
        </div>
    </div>

    <!-- CONTROL STRIP -->
    <div id="controlStrip">
        <div class="panel">
            <div class="panel-label">Data</div>
            <input type="file" id="fileInput" accept=".csv">
            <div style="display:flex;gap:5px;margin-top:7px;">
                <input type="text" id="globalSearch" list="namesList" placeholder="Search employeeâ€¦" style="flex:1;margin-top:0;">
                <button class="btn btn-blue" onclick="focusEmp(g('globalSearch').value)" style="flex-shrink:0;">Go</button>
            </div>
            <div style="display:flex;gap:5px;margin-top:7px;">
                <button class="btn btn-green" style="flex:1;" onclick="dlCSV()">â†“ Export</button>
                <button class="btn btn-gray"  style="flex:1;" onclick="resetAll()">Reset</button>
            </div>
        </div>
        <div class="panel">
            <div class="panel-label">Org Filter</div>
            <select id="filterMode" onchange="toggleFilterUI()">
                <option value="none">Select filter typeâ€¦</option>
                <option value="team">By Manager / Subtree</option>
                <option value="dept">By Department</option>
            </select>
            <div id="filterUI" style="display:none;">
                <input type="text" id="filterVal" list="dynList" placeholder="Enter name or deptâ€¦" style="margin-top:6px;">
                <button class="btn btn-violet" style="width:100%;margin-top:7px;" onclick="applyFilter()">Apply Filter</button>
            </div>
        </div>
        <div class="panel">
            <div class="panel-label">Bulk Actions</div>
            <select id="editMode" onchange="toggleEditUI()">
                <option value="none">Select actionâ€¦</option>
                <option value="move">Reassign Manager</option>
                <option value="deptUpdate">Change Department</option>
                <option value="hire">Add New Hire</option>
                <option value="delete">Remove Employee(s)</option>
            </select>
            <div id="editUI" style="display:none;margin-top:6px;">
                <div id="bubbleSys">
                    <div class="bubble-wrap" id="bubbleBox" onclick="g('editTarget').focus()">
                        <input type="text" id="editTarget" class="bubble-input" list="namesList" placeholder="Type to add employeesâ€¦">
                    </div>
                </div>
                <div id="hireFields" style="display:none;">
                    <input type="text"   id="hireName"  placeholder="Full Name"    style="margin-top:5px;">
                    <input type="number" id="hireSal"   placeholder="Salary ($)"   style="margin-top:5px;">
                    <select id="hireLevel" style="margin-top:5px;"></select>
                </div>
                <input type="text" id="editDest" list="destList" placeholder="Destinationâ€¦" style="margin-top:5px;">
                <button class="btn btn-amber" style="width:100%;margin-top:7px;" onclick="runEdit()">Execute</button>
            </div>
        </div>
    </div>

    <!-- ORG CHART -->
    <div id="chartWrap">
        <div id="emptyState">
            <div class="ei">ğŸ¢</div>
            <p>Upload a CSV file via the Controls panel to visualize your organization</p>
        </div>
        <div class="chart-container"></div>
    </div>
</div>

<!-- SPOTLIGHT -->
<div id="spotlight">
    <div class="spot-head">
        <div class="spot-name" id="sName">â€”</div>
        <div class="spot-x" onclick="closeSpot()">Ã—</div>
    </div>
    <div class="spot-grid">
        <div class="spot-field full"><div class="sfl">Title</div><div class="sfv" id="sTitle">â€”</div></div>
        <div class="spot-field"><div class="sfl">Manager</div><div class="sfv" id="sMgr">â€”</div></div>
        <div class="spot-field"><div class="sfl">Department</div><div class="sfv" id="sDept">â€”</div></div>
        <div class="spot-field"><div class="sfl">Salary</div><div class="sfv" id="sSal">â€”</div></div>
        <div class="spot-field"><div class="sfl">Level</div><div class="sfv" id="sLvl">â€”</div></div>
        <div class="spot-field"><div class="sfl">Rating</div><div class="sfv" id="sRating">â€”</div></div>
        <div class="spot-field"><div class="sfl">Location</div><div class="sfv" id="sLoc">â€”</div></div>
        <div class="spot-field"><div class="sfl">Tenure</div><div class="sfv" id="sTen">â€”</div></div>
        <div class="spot-field full"><div class="sfl">Email</div><div class="sfv em" id="sEmail">â€”</div></div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div id="dashInner">
        <div class="dash-top">
            <div>
                <div class="dash-hl">Executive <span>Intelligence</span></div>
                <div class="dash-sub">Workforce analytics &amp; modeling engine</div>
                <div class="dash-filters">
                    <select id="dDept" onchange="dashFilter('dept')" style="margin-top:0;width:auto;"><option value="">All Departments</option></select>
                    <select id="dMgr"  onchange="dashFilter('team')" style="margin-top:0;width:auto;"><option value="">All Teams</option></select>
                    <button class="btn btn-gray" onclick="resetAll()">Reset</button>
                </div>
            </div>
            <button class="close-dash" onclick="toggleDashboard()">âœ• Close</button>
        </div>
        <div class="dash-layout">
            <div class="dash-sidebar">
                <div class="msec click" onclick="setDrill('salary')">
                    <div class="ml">ğŸ’° Budget</div>
                    <div class="mr"><span class="mk">Total Payroll</span><span class="mv ac" id="dTotal">â€”</span></div>
                    <div class="mr"><span class="mk">Average Salary</span><span class="mv" id="dAvg">â€”</span></div>
                    <div class="mr"><span class="mk">Median Salary</span><span class="mv" id="dMed">â€”</span></div>
                    <div class="mr"><span class="mk">Range</span><span class="mv" id="dRange">â€”</span></div>
                </div>
                <div class="msec click" onclick="setDrill('tier')">
                    <div class="ml">ğŸ› Strategic Tiers</div>
                    <div id="tierList"></div>
                </div>
                <div class="msec click" onclick="setDrill('rating')">
                    <div class="ml">â­ Performance</div>
                    <div id="perfList"></div>
                </div>
                <div class="msec click" onclick="setDrill('headcount')">
                    <div class="ml">ğŸ¢ Departments</div>
                    <div id="deptList" style="max-height:170px;overflow-y:auto;"></div>
                </div>
                <div class="msec">
                    <div class="ml">ğŸ“ Health Ratios</div>
                    <div class="mr"><span class="mk">Avg Span of Control</span><span class="mv" id="dSpan">â€”</span></div>
                    <div class="mr"><span class="mk">Average Tenure</span><span class="mv" id="dTen">â€”</span></div>
                    <div class="mr"><span class="mk">Rolling 12m Hires</span><span class="mv gr" id="dGrowth">â€”</span></div>
                    <div class="mr"><span class="mk">Top Performers 5â˜…</span><span class="mv gr" id="dTop">â€”</span></div>
                    <div class="mr"><span class="mk">Low Performers â‰¤2</span><span class="mv rd" id="dLow">â€”</span></div>
                </div>
            </div>
            <div class="dash-main">
                <div class="tab-row">
                    <button class="tab-btn active" onclick="swTab(this,'tChart')">ğŸ“Š Chart</button>
                    <button class="tab-btn" onclick="swTab(this,'tRisk')">âš ï¸ Risk Flags</button>
                    <button class="tab-btn" onclick="swTab(this,'tTenure')">ğŸ“… Tenure</button>
                    <button class="tab-btn" onclick="swTab(this,'tGeo')">ğŸ“ Locations</button>
                </div>
                <div class="tab-pane active" id="tChart">
                    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;" id="chartLbl">Click a metric card to drill in</div>
                    <div style="height:540px;"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="tab-pane" id="tRisk" style="max-height:620px;overflow-y:auto;">
                    <div class="ml" style="margin-bottom:10px;">Organizational Risk Signals</div>
                    <div id="riskList"></div>
                </div>
                <div class="tab-pane" id="tTenure">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;">
                        <div>
                            <div class="ml" style="margin-bottom:12px;">Tenure Distribution</div>
                            <div id="tenureBars"></div>
                        </div>
                        <div>
                            <div class="ml" style="margin-bottom:12px;">Avg Salary by Job Level</div>
                            <div id="levelBars"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tGeo">
                    <div class="ml" style="margin-bottom:12px;">Headcount by Location</div>
                    <div id="geoList" style="display:grid;grid-template-columns:1fr 1fr;gap:0 22px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI PANEL -->
<div id="aiPanel">
    <div class="ai-hdr">
        <div class="ai-hdr-row">
            <div class="ai-brand">
                <div class="ai-icon">âœ¦</div>
                <div><div class="ai-ttl">Claude AI</div><div class="ai-sub">Workforce Intelligence Assistant</div></div>
            </div>
            <div class="ai-xbtn" onclick="toggleAI()">Ã—</div>
        </div>
        <div class="ai-stat">
            <div class="ai-dot" id="aiDot" style="background:var(--amber);"></div>
            <span class="ai-stxt" id="aiStxt">Load CSV data to activate</span>
        </div>
    </div>
    <div class="chips-wrap">
        <div class="chips-lbl">Quick Questions</div>
        <div class="chips-row">
            <div class="chip" onclick="chipQ(this)">Top performers?</div>
            <div class="chip" onclick="chipQ(this)">Highest paid dept?</div>
            <div class="chip" onclick="chipQ(this)">Span of control issues</div>
            <div class="chip" onclick="chipQ(this)">Longest tenured?</div>
            <div class="chip" onclick="chipQ(this)">Low-rated managers?</div>
            <div class="chip" onclick="chipQ(this)">Summarize Engineering</div>
            <div class="chip" onclick="chipQ(this)">Workforce health report</div>
            <div class="chip" onclick="chipQ(this)">New hires last 6 months</div>
        </div>
    </div>
    <div id="aiMsgs">
        <div class="ai-welcome">
            <div class="wi">âœ¦</div>
            <p><strong>Ask me anything about your organization.</strong><br><br>I analyze headcount, salaries, performance, tenure, reporting structure, and more â€” all from your loaded CSV.</p>
        </div>
    </div>
    <div class="ai-inp-wrap">
        <div class="ai-inp-row">
            <textarea id="aiInput" placeholder="Ask about your orgâ€¦" rows="1" onkeydown="aiKey(event)" oninput="aiResize(this)"></textarea>
            <button id="aiSend" onclick="sendAI()">â¤</button>
        </div>
        <div class="ai-hint">Powered by Claude Â· Analysis uses your loaded CSV data</div>
    </div>
</div>

<datalist id="namesList"></datalist>
<datalist id="dynList"></datalist>
<datalist id="destList"></datalist>

<!-- Scripts: state â†’ csv â†’ chart â†’ dashboard â†’ ai â†’ drag â†’ app -->
<script src="js/state.js"></script>
<script src="js/csv.js"></script>
<script src="js/chart.js"></script>
<script src="js/dashboard.js"></script>
<script src="js/ai.js"></script>
<script src="js/drag.js"></script>
<script src="js/app.js"></script>
</body>
</html>
